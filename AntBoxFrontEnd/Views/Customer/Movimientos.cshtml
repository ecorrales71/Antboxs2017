@model AntBoxFrontEnd.Services.Tasks.PaginationCustomerTask 
@{
    ViewBag.Title = "Index";
}
<!-- WRAPPER -->
<div class="wrapper">
    <!-- CONTENT -->
    <div class="content movimientos">
        <!-- CONTAINER -->
        <div class="container">
            <div class="row irow-xs">
                <div class="col-sm-12">
                    <h1>Movimientos</h1>
                    <div class="heading-divider"></div>
                </div>
            </div>
        </div>
        <!-- /.container -->
        <!-- CONTAINER -->
        <div class="container mt30">
            @Html.Hidden("idpagination", @Model.Pagination_id)
            @Html.Hidden("total", @Model.Total)
            @Html.Hidden("pages", @Model.Pages)
            <div class="row">
                <div class="col-md-3 pr0 no_portrait">
                    @Html.Partial("_LeftMenu")
                </div>
                <div class="col-md-9">
                    <div class="row pl30 pr30">
                        <div class="irow-xs pb30">
                            <h3>Historial de movimientos</h3>
                            <p>Revisa el estatus de tus movimientos realizados y consulta el historial de movimientos anteriores.</p>
                        </div>

                        <div id="TasksList">
                            @Html.Partial("_CustomerTasks", Model.Tasks)
                        </div>
                    </div>
                    <div id="loader" role="alert" style="display: none;">
                        <img src="@Url.Content("~/Images/preloader.gif")" />   Cargando movimientos... &nbsp;
                    </div>
                    <div class="pagination solid text-center"></div>
                    <div class="row">
                        <div class="col-sm-12 pl0 pr0 pt20 text-center">
                            <!-- PAGINATION -->
                            <!-- /.pagination -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.container -->
    </div>
    <!-- /.content -->
    <?php include 'includes/promobox.php';?>

</div>
<!-- /.wrapper -->

<!-- Modal Medium -->
<div class="modal fade" id="recibo_recoleccion">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times"></i></button>
                <h6 class="modal-title">Recibo de Recolección</h6>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="row sm_center">
                            <div class="col-sm-6">
                                <img src="@Url.Content("~/Content/Images/antboxs_logo.png")" alt="Antboxs">
                            </div>
                            <div class="col-sm-6">
                                <p class="font_recibo_notas sapi">Antboxs México SAPI de C.V.</p>
                            </div>
                        </div>
                        <hr class="hr-semilight linea_recibo" />
                        <div>
                            <p>
                                Orden de Servicio 3457837
                                <br />Fecha: 24-10-2016 Hora: 10:00 am
                            </p>
                            <p>
                                Eduardo Corrales
                                <br />Begonias 130-4,
                                <br />Colonia Nueva Santa Maria,
                                <br />Delegación Azcapotzalco, C.P. 02800
                                <br />Cel. 55-3748-5733 Ref. Reja café
                            </p>
                            <p>
                                Antboxs Medianas: 1
                                <br />Antboxs Grandes: 2
                            </p>
                            <hr class="hr-semilight linea_recibo" />
                        </div>
                        <div>
                            <p>
                                Antboxs Mediana 1 01-3457837-37263527-58261475 R
                                <br />Candado 1: 37263527	Candado 2: 58261475
                                <br />Antboxs Grande 1 01-3457837-37263524-18263327 R
                                <br />Candado 1: 37263524	Candado 2: 18263327
                            </p>
                            <p>Antboxs Grande 2 - Depósito</p>
                        </div>
                        <hr class="hr-semilight linea_recibo" />
                        <div class="row">
                            <div class="col-sm-5 a_center">
                                <img class="img_firma_cliente" src="@Url.Content("~/Content/Images/firma_cliente.jpg")" alt="Firma Cliente">
                                <p class="firma_cliente">Firma Cliente</p>
                            </div>
                            <div class="col-sm-7">
                                <p>
                                    Rentas:<span class="pull-right">$198.00</span>
                                    <br />Depósitos:<span class="pull-right">$158.00</span>
                                    <br />Cargos TC:<span class="pull-right">$356.00</span>
                                    <br />Reembolso TC:<span class="pull-right">$0.00</span>
                                </p>
                            </div>
                        </div>
                        <hr class="hr-semilight linea_recibo" />
                        <div>
                            <p class="font_recibo_notas">
                                "Al aceptar, Yo el Cliente garantizo que los Antboxs recolectados es a mi entera responsabilidad y que los mismos se entregan sellados".
                                <br />Los reembolsos se pueden ver reflejados en un periodo de 72 hrs.
                            </p>
                        </div>
                    </div>
                    <div class="col-sm-12 mt10">
                        <input type="submit" class="btn btn-primary btn-wide pull-right" value="Descargar">
                        <p class="succs-msg">Мensaje enviado</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /.modal -->
<!-- Modal Medium -->
<div class="modal fade" id="recibo_entrega">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times"></i></button>
                <h6 class="modal-title">Recibo de Entrega</h6>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="row sm_center">
                            <div class="col-sm-6">
                                <img src="@Url.Content("~/Content/Images/antboxs_logo.png")" alt="Antboxs">
                            </div>
                            <div class="col-sm-6">
                                <p class="font_recibo_notas sapi">Antboxs México SAPI de C.V.</p>
                            </div>
                        </div>
                        <hr class="hr-semilight linea_recibo" />
                        <div>
                            <p>
                                Orden de Servicio 3457838
                                <br />Fecha: 24-10-2016 Hora: 11:35 am
                            </p>
                            <p>
                                Susana Gómez
                                <br />Nortes 81-4,
                                <br />Colonia Claveria,
                                <br />Delegación Azcapotzalco, C.P. 02080
                                <br />Cel. 55-3748-5733 Ref. Hablar al llegar
                            </p>
                            <p>
                                Antboxs Medianas: 1
                                <br />Antboxs Grandes: 1
                            </p>
                            <hr class="hr-semilight linea_recibo" />
                        </div>
                        <div>
                            <p>
                                Antboxs Mediana 1 01-3457838-37263545-58224578
                                <br />Descripción: XXX
                                <br />Candado 1: 37263545	Candado 2: 58224578
                                <br />Antboxs Grande 1 02-3457838-17263526-25844375
                                <br />Descripción: YYY
                                <br />Candado 1: 17263526	Candado 2: 25844375
                            </p>
                        </div>
                        <hr class="hr-semilight linea_recibo" />
                        <div class="a_center">
                            <img class="img_firma_cliente" src="@Url.Content("~/Content/Images/firma_cliente.png")" alt="Firma Cliente">
                            <p class="firma_cliente">Firma Cliente</p>
                        </div>
                        <hr class="hr-semilight linea_recibo" />
                        <div>
                            <p class="font_recibo_notas">"Yo el Cliente garantizo que los Antboxs descritos en el presente documento, a mi entera satisfacción y en óptimo estado liberando a Antboxs México SAPI de C.V. de cualquier reclamación al respecto, lo(s) Antboxs recibidos se entregaron sellados".
                        </div>
                    </div>
                    <div class="col-sm-12 mt10">
                        <input type="submit" class="btn btn-primary btn-wide pull-right" value="Descargar">
                        <p class="succs-msg">Мensaje enviado</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /.modal -->
<!-- Modal Medium -->
<div class="modal fade" id="solicitar">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times"></i></button>
                <h6 class="modal-title">Solicitar mi Antboxs</h6>
            </div>
            <div class="modal-body">
                <div id="loader-solicitar" role="alert" style="display: none;">
                    <img src="@Url.Content("~/Images/preloader.gif")" />   Solicitando antboxs... &nbsp;
                </div>
                <form method="post" class="contact-form form-solid form-solicitar-antbox" novalidate>
                    <input type="hidden" class="folio-form" value="" />
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group mb0">
                                <label for="address">Dirección de entrega</label>
                                <select id="address" name="address">
                                    @if (Model.Addresses != null)
                                    {
                                        foreach (var item in Model.Addresses)
                                        {
                                            if (item != null)
                                            {
                                                <option value='@item.Id.ToString()'> @item.Alias</option>
                                            }
                                        }
                                    }
                                </select>
                                @Html.ActionLink("Nueva direción", "Direcciones", "Customer", new { @class = "pull-right" })
                            </div>
                            <label for="textbox">Fecha</label>
                            <div class="input-group">
                                <span class="input-group-btn">
                                    <button type="button" id="entrega" class="btn btn-primary pull-right"><i class="fa fa-calendar"></i></button>
                                </span>
                                <input class="form-control" type="text" id="fecha_entrega" name="fecha_entrega" disabled="disable">
                            </div>
                            <div class="form-group">
                                <input type="hidden" name="horariostring" id="horariostring" value="" />
                                <label for="horario">Horario de entrega</label>
                                <select id="horario" name="horario">
                                    <option value>- Selecciona una opción -</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6 pl0_modal">
                            <div class="form-group">
                                <label for="referencia">Referencias o comentarios</label>
                                <textarea name="referencia" id="referencia"></textarea>
                            </div>
                        </div>
                        <div class="col-sm-12 mt10">
                            <input type="button" class="btn btn-primary btn-wide pull-right solicitar-antbox" value="Solicitar">
                            <p class="succs-msg">Мensaje enviado</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- /.modal -->

@section css {
    @Styles.Render("~/Content/simplepaginationcss")
}

@section scripts {
@Scripts.Render("~/bundles/simplepaginationjs")
<script type="text/javascript">
    Calendar.setup({
        inputField: "fecha_entrega",      // id del campo de texto
        ifFormat: "%Y-%m-%d",       // formato de la fecha, cuando se escriba en el campo de texto
        button: "entrega",   // el id del botón que lanzará el calendario
        onUpdate: function () {
            var date = $("#fecha_entrega").val();
            $.ajax({
                url: '@Url.Action("getSchedules", "Customer")',
                type: "GET",
                data: { "date": date },
                success: function (schedules) {
                    // alert("<option value='" + schedules[0].worker + "'>" + schedules[0].Start + " - " + schedules[0].End + " hrs.</option>");
                    $("#horario").html("");
                    var items = '<option>Seleccciona un horario disponible</option>';
                    for (var i = 0; i < schedules.length ; i++) {
                        items += "<option value='" + schedules[i].worker + "'>" + schedules[i].Start + " - " + schedules[i].End + " hrs.</option>";
                    }
                    $('#horario').html(items);
                    $('#horario').trigger("chosen:updated");
                }
            });
        }
    });
    $(function () {

        $('.solicitar').click(function (event) {
            event.preventDefault();
            $(".folio-form").val($(this).attr("data-folio"));
            $('#solicitar').modal("show");
        });

        $('.pagination').pagination({
            items: $('#total').val(),
            itemsOnPage: 20,
            cssStyle: 'light-theme',
            onPageClick: function (pageNumber, event) {
                event.preventDefault();

                $("#TasksList").html('');
                pageLoading(true);
                var formData = { idPagination: $('#idpagination').val(), page: pageNumber };
                var cadhtml = "";
                var tasksresult = "";

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("PaginationAjax", "Movimientos")',
                    data: formData,
                    success: function (result) {

                        tasksresult = "";

                        for (var i = 0; i < result.Tasks.length; i++) {

                            var taskv = result.Tasks[i];
                            var address = taskv.Address.Street + " " + taskv.Address.External_number + ", " + taskv.Address.Neighborhood + ", " + taskv.Address.City + ", C.P. " + taskv.Address.Zipcode + ".";

                            var cadhtml = "";
                            cadhtml += "<div class=\"col-sm-12 back_gris pt30 pb20 mb30\">";
                            cadhtml += "    <div class=\"media-left\">";
                            cadhtml += "        <div class=\"icon icon-color icon-size-4\">";
                            if (taskv.Type == "pickup")
                                cadhtml += "            <i class=\"fa fa-truck fa-flip-horizontal\"><\/i>";
                            else
                                cadhtml += "            <i class=\"fa fa-archive\"><\/i>";
                            cadhtml += "        <\/div>";
                            cadhtml += "    <\/div>";
                            cadhtml += "    <div class=\"media-body\">";
                            if (taskv.Type == "pickup")
                                cadhtml += "        <h4>Recolección<\/h4>";
                            else
                                cadhtml += "        <h4>Entrega<\/h4>";
                            cadhtml += "        <p>Fecha: " + timeConverter(taskv.completeAfter) + "<br \/>Lugar: " + address + "<\/p>";
                            if (taskv.Status == "completed")
                                cadhtml += "<div class=\"sticker_mov completed\">Completado<\/div>";
                            else if (taskv.Status == "inprogress")
                                cadhtml += "<div class=\"sticker_mov in_progress\">En progreso<\/div>";
                            else if (taskv.Status == "canceled")
                                cadhtml += "<div class=\"sticker_mov canceled\">Cancelado<\/div>";
                            cadhtml += "    <\/div>";
                            cadhtml += "<\/div>";

                            tasksresult += cadhtml;
                        }

                        $("#TasksList").html(tasksresult);

                        console.log(result);
                        pageLoading(false);

                    }
                });

            }
        });

        $('.solicitar-antbox').click(function (event) {

            event.preventDefault();

            var checkeds = ["1"];
            var succesed = [];
            var count = 0;

            $("#loader-solicitar").show();
            console.log($(".select-antbox:checked").length);

            var formData = {
                worker: $("#horario").val(),
                address: $("#address").val(),
                fecha: $("#fecha_entrega").val(),
                hora: $('#horariostring').val(),
                referencia: $('#referencia').val(),
                folioEntrega: $(".folio-form").val()
            };

            console.log(formData);

            $.ajax({
                type: 'POST',
                url: '@Url.Action("SolicitarAntbox", "AntBox")',
                data: formData,
                success: function (result) {
                    console.log(result);
                    if (result.success == true) {
                        //antbox editado
                        succesed.push(1);
                        console.log('result succes');
                    } else {
                        succesed.push(0);
                        console.log('result false');
                    }
                }, error: function (dataerror) {
                    console.log(dataerror);
                    succesed.push(0);
                }, complete: function () {
                    count++;
                    if (count == checkeds.length) {
                        var mensaje = "Antboxs solicitados correctamente";
                        if (checkeds.length == 1) mensaje = "Antbox solicitado correctamente";
                        $("#loader-solicitar").hide();
                        if (!$('#SolicitarAntBoxSuccess').length) {
                            $('.form-solicitar-antbox').prepend('<div class="alert alert-success alert-dismissible fade in" id="SolicitarAntBoxSuccess"> <button type="button" class="close" data-dismiss="alert"> <i class="fa fa-times"></i></button><p><i class="fa fa-check"></i>' + mensaje + '</p></div>');
                            window.setTimeout(function () {
                                $('#SolicitarAntBoxSuccess').remove();
                            }, 3000);
                            window.setTimeout(function () {
                                $(".select-antbox:checked").each(function () {
                                    $(this).prop('checked', false);
                                });
                                $('#solicitar').modal('hide');
                            }, 1000);
                        }
                        element.parent().find('.name-antbox').text($('#mname-antbox').val());
                        element.parent().find('.description-antbox').text($('#mdescription-antbox').val());
                    }
                }
            });
            console.log(checkeds);

        });

        $(document).on('change', '#horario', function () {
            console.log("change horario");
            var horario = $("#horario").val();
            var t = $("#horario option:selected").text();
            $("#horariostring").val(t);
        })

        function pageLoading(status) {
            if (status) {
                $("#loader").css('display', 'block');
            }
            else {
                $("#loader").css('display', 'none');
            }
        }

        function timeConverter(UNIX_timestamp) {
            var a = new Date(UNIX_timestamp);
            var year = a.getUTCFullYear();
            var month = a.getUTCMonth() + 1;
            month = ('0' + month).slice(-2);
            var date = a.getUTCDate();
            date = ('0' + date).slice(-2);
            var time = date + '/' + month + '/' + year + ' ' + formatAMPM(a);
            return time;
        }

        function formatAMPM(date) {
            var hours = date.getUTCHours();
            var minutes = date.getUTCMinutes();
            var seconds = date.getUTCSeconds();
            var ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            minutes = ('0' + minutes).slice(-2);
            seconds = ('0' + seconds).slice(-2);
            var strTime = hours + ':' + minutes + ':' + seconds + ' ' + ampm;
            return strTime;
        }

    })
</script>
}