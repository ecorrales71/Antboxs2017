@model AntBoxFrontEnd.Services.AntBoxes.PaginationAntBoxes
@{
    ViewBag.Title = "Index";
}
<!-- WRAPPER -->
<div class="wrapper">
    <!-- CONTENT -->
    <div class="content mis_antboxs">
        <!-- CONTAINER -->
        <div class="container">
            <div class="row irow-xs">
                <div class="col-sm-12">
                    <h1>Mis Antboxs</h1>
                    <div class="heading-divider"></div>
                </div>
            </div>
        </div>
        <!-- /.container -->
        <!-- CONTAINER -->
        <div class="container mt30">
            @Html.Hidden("idpagination", @Model.Pagination_id)
            @Html.Hidden("total", @Model.Total)
            @Html.Hidden("pages", @Model.Pages)
            <div class="row">
                <div class="col-md-3 pr0 no_portrait">
                    @Html.Partial("_LeftMenu")
                </div>
                <div class="col-md-9">

                    <div class="row">
                        <div class="irow-xs pb30 pl30 pr30">
                            <h3>Mis Antboxs almacenados</h3>
                            <p>Programa la solicitud de tus Antboxs en el momento que tú decidas. Agrega una descripción que te permita identificar su contenido fácilmente.</p>
                        </div>
                        <div id="antboxs-container">
                            @Html.Partial("_CustomerAntboxs", Model.Antboxs)
                        </div>
                    </div>
                    <div id="loader" role="alert" style="display: none;">
                        <img src="@Url.Content("~/Images/preloader.gif")" />   Cargando antboxs... &nbsp;
                    </div>
                    <div class="pagination solid text-center"></div>
                    <div class="row">
                        <div class="col-sm-12 pl0 pr0 pt20 text-center">
                            <!-- PAGINATION -->
                            
                            <!-- /.pagination -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.container -->
    </div>
    <!-- /.content -->
    <?php include 'includes/promobox.php';?>

</div>
<!-- /.wrapper -->
<?php include 'includes/footer.php';?>

<!-- Modal Small -->
<div class="modal fade" id="editar">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times"></i></button>
                <h6 class="modal-title">Editar mi Antboxs</h6>
            </div>
            <div class="modal-body">
                <form action="../../php/email.php" method="post" class="contact-form form-solid form-editar-antbox" novalidate>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="mname-antbox">Nombre de mi Antboxs</label>
                                <input type="text" name="mname-antbox" id="mname-antbox" placeholder="Mi Antbox">
                            </div>
                            <div class="form-group">
                                <label for="mdescription-antbox">Descripción</label>
                                <textarea name="mdescription-antbox" id="mdescription-antbox"></textarea>
                            </div>
                        </div>
                        <div class="col-sm-12 mt10">
                            <input type="submit" class="btn btn-primary btn-wide pull-right guardar-antbox" value="Guardar">
                            <p class="succs-msg">Мensaje enviado</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- /.modal -->
<!-- Modal Medium -->
<div class="modal fade" id="solicitar">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times"></i></button>
                <h6 class="modal-title">Solicitar mi Antboxs</h6>
            </div>
            <div class="modal-body">
                <div id="loader-solicitar" role="alert" style="display: none;">
                    <img src="@Url.Content("~/Images/preloader.gif")" />   Solicitando antboxs... &nbsp;
                </div>
                <form method="post" class="contact-form form-solid form-solicitar-antbox" novalidate>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group mb0">
                                <label for="address">Dirección de entrega</label>
                                <select id="address" name="address">
                                    @if (Model.Addresses != null)
                                    {
                                        foreach (var item in Model.Addresses)
                                        {
                                            if (item != null)
                                            {
                                                <option value='@item.Id.ToString()'> @item.Alias</option>
                                            }
                                        }
                                    }
                                </select>
                                @Html.ActionLink("Nueva direción", "Direcciones", "Customer", new { @class = "pull-right" })
                            </div>
                            <label for="textbox">Fecha</label>
                            <div class="input-group">
                                <span class="input-group-btn">
                                    <button type="button" id="entrega" class="btn btn-primary pull-right"><i class="fa fa-calendar"></i></button>
                                </span>
                                <input class="form-control" type="text" id="fecha_entrega" name="fecha_entrega" disabled="disable">
                            </div>
                            <div class="form-group">
                                <input type="hidden" name="horariostring" id="horariostring" value="" />
                                <label for="horario">Horario de entrega</label>
                                <select id="horario" name="horario" >
                                    <option value>- Selecciona una opción -</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6 pl0_modal">
                            <div class="form-group">
                                <label for="referencia">Referencias o comentarios</label>
                                <textarea name="referencia" id="referencia"></textarea>
                            </div>
                        </div>
                        <div class="col-sm-12 mt10">
                            <input type="button" class="btn btn-primary btn-wide pull-right solicitar-antbox" value="Solicitar">
                            <p class="succs-msg">Мensaje enviado</p>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- /.modal -->

@section css {
    @Styles.Render("~/Content/simplepaginationcss")
}

@section scripts {
@Scripts.Render("~/bundles/simplepaginationjs")
<script type="text/javascript">
    Calendar.setup({
        inputField     :    "fecha_entrega",      // id del campo de texto
        ifFormat       :    "%Y-%m-%d",       // formato de la fecha, cuando se escriba en el campo de texto
        button: "entrega",   // el id del botón que lanzará el calendario
        onUpdate: function() {
            var date = $("#fecha_entrega").val();
            $.ajax({
                url: '@Url.Action("getSchedules", "Customer")',
                type: "GET",
                data: { "date": date },
                success: function (schedules) {
                    // alert("<option value='" + schedules[0].worker + "'>" + schedules[0].Start + " - " + schedules[0].End + " hrs.</option>");
                    $("#horario").html("");
                    var items = '<option>Seleccciona un horario disponible</option>';
                    for (var i = 0; i < schedules.length ; i++) {
                        items += "<option value='" + schedules[i].worker + "'>" + schedules[i].Start + " - " + schedules[i].End + " hrs.</option>";
                    }
                    $('#horario').html(items);
                    $('#horario').trigger("chosen:updated");
                }
            });
        }
    });
    $(function () {
        //editar andbox
        var element = null;
        var ideditar = null;
        $(document).on("click", ".editar", function () {
            element = $(this);
            var name = element.parent().find('.name-antbox').text();
            var description = element.parent().find('.description-antbox').text();
            var ideditar = element.attr('data-id');

            if (name != "Mi Antbox") $('#mname-antbox').val(name);
            else $('#mname-antbox').val('');

            if (description != "" || description != "undefined") $('#mdescription-antbox').val(description);
            else $('#mdescription-antbox').val('');
        });

        $(document).on("click", ".solicitar", function () {
            element = $(this);
            var elementchecked = $(this).closest("div").find(".select-antbox");
            elementchecked.prop('checked', true);
        });

        $('.guardar-antbox').click(function (event) {
            event.preventDefault();
            $.ajax({
                type: 'POST',
                url: '@Url.Action("UpdateAjax", "AntBox")',
            data: { id: element.attr('data-id'), name: $('#mname-antbox').val(), description: $('#mdescription-antbox').val() },
            success: function (result) {
                if (result.success == true) {
                    //antbox editado
                    if (!$('#UpdateAntBoxSuccess').length)
                    {
                        $('.form-editar-antbox').prepend('<div class="alert alert-success alert-dismissible fade in" id="UpdateAntBoxSuccess"> <button type="button" class="close" data-dismiss="alert"> <i class="fa fa-times"></i></button><p><i class="fa fa-check"></i>Se ha actualizado la información.</p></div>');
                        window.setTimeout(function () {
                            $('#UpdateAntBoxSuccess').hide();
                        }, 3000);
                        window.setTimeout(function () {
                            $('#mname-antbox').val('');
                            $('#mdescription-antbox').val('');
                            $('#editar').modal('hide');
                        }, 500);
                    }
                    element.parent().find('.name-antbox').text($('#mname-antbox').val());
                    element.parent().find('.description-antbox').text($('#mdescription-antbox').val());
                } else {

                }
            }
            });
        });

        $('.solicitar-antbox').click(function (event) {

            event.preventDefault();

            var checkeds = [];
            var succesed = [];
            var count = 0;

            $("#loader-solicitar").show();
            $(".select-antbox:checked").each(function () {
                var folio = $(this).attr("data-folio");
                checkeds.push(folio);

                var formData = {
                    worker: $("#horario").val(),
                    address: $("#address").val(),
                    fecha: $("#fecha_entrega").val(),
                    hora: $('#horariostring').val(),
                    referencia: $('#referencia').val(),
                    folioEntrega: folio
                };

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("SolicitarAntbox", "AntBox")',
                    data: formData,
                    success: function (result) {
                        if (result.success == true) {
                            //antbox editado
                            succesed.push(1);
                        } else {
                            succesed.push(0);
                        }
                    }, error: function (dataerror) {
                        succesed.push(0);
                    }, complete: function () {
                        count++;
                        if (count == checkeds.length)
                        {
                            var mensaje = "Antboxs solicitados correctamente";
                            if (checkeds.length > 1) mensaje = "Antbox solicitado correctamente";
                            $("#loader-solicitar").hide();
                            if (!$('#SolicitarAntBoxSuccess').length) {
                                $('.form-solicitar-antbox').prepend('<div class="alert alert-success alert-dismissible fade in" id="SolicitarAntBoxSuccess"> <button type="button" class="close" data-dismiss="alert"> <i class="fa fa-times"></i></button><p><i class="fa fa-check"></i>' + mensaje + '</p></div>');
                                window.setTimeout(function () {
                                    $('#SolicitarAntBoxSuccess').remove();
                                }, 3000);
                                window.setTimeout(function () {
                                    $(".select-antbox:checked").each(function () {
                                        $(this).prop('checked', false);
                                    });
                                    $('#solicitar').modal('hide');
                                }, 1000);
                            }
                            element.parent().find('.name-antbox').text($('#mname-antbox').val());
                            element.parent().find('.description-antbox').text($('#mdescription-antbox').val());
                        }
                    }
                });
            });

            console.log(checkeds);

        });

        $(document).on('change', '#horario', function () {
            console.log("change horario");
            var horario = $("#horario").val();
            var t = $("#horario option:selected").text();
            $("#horariostring").val(t);
        })

        $('.pagination').pagination({
            items: $('#total').val(),
            itemsOnPage: 20,
            cssStyle: 'light-theme',
            onPageClick: function (pageNumber, event) {
                event.preventDefault();

                $("#antboxs-container").html('');
                pageLoading(true);
                var formData = { idPagination : $('#idpagination').val(), page: pageNumber };
                var cadhtml = "";
                var antboxsresult = "";

                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("PaginationAjax", "AntBox")',
                    data: formData,
                    success: function (result) {

                        antboxsresult = "";

                        for (var i = 0; i < result.Antboxs.length; i++)
                        {

                            var antboxv = result.Antboxs[i];

                            cadhtml = "";
                            cadhtml += "<div class=\"col-sm-12 mb20\">";
                            cadhtml += "                <div class=\"card card-border-dashed card-border-color magnific-wrap\">";
                            cadhtml += "                    <div class=\"row\">";
                            cadhtml += "                        <div class=\"col-sm-4 col-xs-12\">";
                            cadhtml += "                            <figure class=\"figure\">";
                            cadhtml += "                                <img src=\"\/images\/antboxs_3.jpg\" alt=\"\">";
                            cadhtml += "                                <div class=\"mask mask-dark\">";
                            cadhtml += "                                    <nav>";
                            cadhtml += "                                        <a class=\"icon icon-inverse icon-size-1 icon-theme icon-rounded magnific\" title=\"Antboxs 1\" href=\"\/images\/antboxs_3.jpg\">";
                            cadhtml += "                                            <i class=\"fa fa-search\"><\/i>";
                            cadhtml += "                                        <\/a>";
                            cadhtml += "                                    <\/nav>";
                            cadhtml += "                                <\/div>";
                            cadhtml += "                            <\/figure>";
                            cadhtml += "                        <\/div>";
                            cadhtml += "                        <div class=\"col-sm-8 col-xs-12 antboxs_txt\" >";
                            cadhtml += "                            <h4><span class=\"name-antbox\">"+ antboxv.Name +" - "+ antboxv.Folio +"<\/h4>";
                            cadhtml += "                            <p class=\"description-antbox\">" + antboxv.Descriptionv + "<\/p>";
                            cadhtml += "                            <button type=\"button\" class=\"btn btn-primary btn-sm pull-right ml20 solicitar\" data-toggle=\"modal\" data-folio=\"" + antboxv.Folio + "\" data-id=\"" + antboxv.Id + "\" data-target=\"#solicitar\">Solicitar<\/button>";
                            cadhtml += "                            <button type=\"button\" class=\"btn btn-primary btn-sm pull-right btn_blue editar\" data-toggle=\"modal\" data-id=\"" + antboxv.Id + "\" data-target=\"#editar\">Editar<\/button>";
                            cadhtml += "                        <\/div>";
                            cadhtml += "                    <\/div>";
                            cadhtml += "                <\/div>";
                            cadhtml += "            <\/div>";

                            antboxsresult += cadhtml;
                        }

                        $("#antboxs-container").html( antboxsresult );

                        console.log(result);
                        pageLoading(false);
                   
                    }
                });

            }
        });

    function pageLoading(status) {
        if (status) {
            $("#loader").css('display', 'block');
        }
        else {
            $("#loader").css('display', 'none');
        }
    }

})
</script>
}